{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    {#    <meta charset="UTF-8">#}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}EcoPet{% endblock %}</title>
    <!-- Import bootstraps css -->
    <link rel="stylesheet" href="{% static 'css/styleAll.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet"/>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"/>
    <script>
        const streakURL = "{% url 'challenges:update_streak' %}";
        const updateLocURL = "{% url 'users:update_location' %}";
        const csrfToken = "{{ csrf_token }}";
    </script>
    <script type="module" src="{% static 'js/locationUpdater.js' %}"></script>
    <script type="module" src="{% static 'js/updateChallenges.js' %}"></script>
    {% block extrahead %}{% endblock %} <!-- extra head block for additional code here -->

</head>
<body class="d-flex flex-column min-vh-100">

{% block topBar %}
    <nav class="navbar navbar-dark bg-dark py-2">
        <div class="container-fluid">
            {% if user.is_authenticated %}
                {% with pet=user.pets.all|first %}
                    <p class="mb-0 w-100 text-center navbar-text">
                        Hello {{ user.first_name|default:user.username }}, it's time to get
                        {% if pet %}
                            {{ pet.name }}
                        {% else %}
                            your pet
                        {% endif %}
                        moving!
                    </p>
                {% endwith %}
            {% else %}
                <p class="mb-0 w-100 text-center navbar-text">
                    Hello Guest, Please
                    <a href="{% url 'users:login' %}" class="text-white">log in</a> or
                    <a href="{% url 'users:registration' %}" class="text-white">register</a> to see
                    your pet!
                </p>
            {% endif %}
        </div>
    </nav>
{% endblock %}



<nav class="navbar navbar-expand-lg">
    <div class="container">
        <a class="navbar-brand" href="{% url 'homepage' %}">
            <img src="{% static 'media/ecoPetLogo.png' %}" alt="EcoPet Logo" class="logo img-fluid"
                 style="height: 40px;">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-center">
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'homepage' %}">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'locations:base' %}">Locations</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'leaderboard:leaderboard' %}">Leaderboard</a>
                </li>
                {% if user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'pets:mypet' %}">Your Pet</a>
                    </li>
                {% endif %}
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'about' %}">About</a>
                </li>

                <li class="nav-item ms-4">

                <li class="nav-item">
                    <a class="nav-link" href="#" id="qrScannerIcon" onclick="triggerFileInput()">
                        <i class="bi bi-qr-code-scan"></i>
                    </a>
                </li>

                <li class="nav-item dropdown ">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                       data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        {% if user.is_authenticated %}
                            <li>
                                <a class="dropdown-item"
                                   href="{% url 'users:user_profile' user.username %}">Profile</a>
                            </li>
                            <li>
                                <a class="dropdown-item"
                                   href="{% url 'users:group_home' %}">Groups</a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'users:logout' %}">Sign
                                    Out</a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'users:password_change' %}">Change
                                    Password</a>
                            </li>
                            {% if user.is_staff %}
                                <li>
                                    <a class="dropdown-item" href="/admin">Admin</a>
                                </li>
                            {% endif %}
                        {% else %}
                            <li>
                                <a class="dropdown-item" href="{% url 'users:login' %}">Log in</a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="{% url 'users:registration' %}">Register</a>
                            </li>
                        {% endif %}
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<main class="container my-4 flex-grow-1">
    {% block content %}
    {% endblock %}
</main>

<!-- Footer -->
<footer>
    <div class="footer-content">
        <div class="footer-logo">
            <img src="{% static 'media/ecoPetLogo.png' %}" alt="EcoPet Logo"
                 class="footer-logo-img">
        </div>
        <div class="footer-links">
            <div class="footer-column">
                <h3>Resources & Support</h3>
                <a href="{% url 'faq' %}">Help & FAQ</a>
                <a href="{% url 'contact' %}">Contact us</a>
                <a href="{% url 'about' %}">About us</a>
                <a href="{% url 'gdpr' %}">GDPR & Privacy Policy</a>
            </div>
        </div>
    </div>
    <div class="footer-bottom">
        <p>Make sure to keep your pet alive!</p>
    </div>
</footer>

{# Code below is for QR scanning #}

<input type="file" accept="image/*" capture="environment" id="qrFileInput" style="display: none;">

{# Use the zxing lib as its better at reading complex qr codes like ours #}
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    /**
     * This triggers the file input
     */
    function triggerFileInput() {
        document.getElementById('qrFileInput').click();
    }

    /**
     * This function takes a qr url and sends it to the server to possibly redirect
     *
     * @param qrString The string to send
     */
    function sendQRToServer(qrString) {
        fetch("{% url 'locations:validate_qr' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({qr_code: qrString})
        })
            .then(response => {
                // If the response is a redirect, use its URL
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    return response.json().then(data => {
                        if (data.error && data.error === 'INVALID_QR') {
                            alert('The QR is not in the database or was misread');
                            console.error("Error:", data.error);
                        }
                    });
                }
            })
    }

    // Listen for changes on the file input to process and decode the QR code
    document.getElementById('qrFileInput').addEventListener('change', function (event) {
        var file = event.target.files[0];
        if (file) { // if there is a file to read
            const reader = new FileReader();
            reader.onload = function (e) {
                const dataURL = e.target.result;

                // Instantiate the ZXing BrowserQRCodeReader
                const codeReader = new ZXing.BrowserQRCodeReader();
                codeReader.decodeFromImageUrl(dataURL)
                    .then(result => {
                        console.log("QR code scanned:", result.text);

                        sendQRToServer(result.text); // make the API req to the server
                    })
                    .catch(err => {
                        console.error("QR code decode error:", err);
                    });
            };
            reader.readAsDataURL(file);
        }
        event.target.value = ''; // Reset the file input so it works again
    });
</script>
</body>
</html>
