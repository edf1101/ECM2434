{% extends 'layout.html' %}
{% load static %}

{% block title %}PetReal - Home{% endblock %}

{% block extrahead %}
  <link rel="stylesheet" href="{% static 'petreal/css/petreal_style.css' %}">
  <link rel="stylesheet" href="{% static 'css/styleAll.css' %}">
  <style>
    .petreal-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    .petreal-hero {
      background: linear-gradient(135deg, #106A1A, #28963D);
      color: #fff;
      text-align: center;
      padding: 60px 20px;
      border-radius: 12px;
      margin-bottom: 40px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }
    .petreal-hero h1 {
      font-size: 3em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
    }
    .petreal-hero h5 {
      font-size: 1.5em;
      margin-bottom: 20px;
    }
    .petreal-hero hr {
      border-top: 2px solid rgba(255,255,255,0.5);
      width: 50%;
      margin: 20px auto;
    }
    .petreal-hero p {
      font-size: 1.2em;
    }
    .photo-carousel {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      padding: 10px;
      gap: 10px;
      scrollbar-width: none;
    }
    .photo-carousel::-webkit-scrollbar {
      display: none;
    }
    .photo-card {
      flex: 0 0 300px;
      scroll-snap-align: start;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .card-body {
      text-align: center;
      padding: 10px;
    }
    .card-body img, .card-body video {
      width: 100%;
      display: block;
      border-bottom: 1px solid #ddd;
    }
    .post-time {
      font-size: 0.9em;
      color: #888;
      margin-top: 5px;
    }
    .card-footer {
      background: #f8f9fa;
      padding: 10px;
    }
    .reaction-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
    }
    .reaction-icon {
      position: relative;
      font-size: 2em;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .reaction-icon:hover {
      transform: scale(1.1);
    }
    .reaction-count {
      position: absolute;
      bottom: -12px;
      right: -8px;
      background: white;
      border-radius: 50%;
      padding: 2px 6px;
      font-size: 0.7em;
      border: 1px solid #ddd;
    }
    .add-reaction {
      display: none;
    }
  </style>
  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
    }
    function addReaction(photoId, reaction) {
      fetch(window.addReactionUrl, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
              photo_id: photoId,
              reaction: reaction
          })
      })
      .then(response => {
          if (!response.ok) {
              throw new Error('Network response was not ok');
          }
          return response.json();
      })
      .then(data => {
          const thumbsUpElem = document.getElementById(`reaction-thumbs-up-${photoId}`);
          const thumbsDownElem = document.getElementById(`reaction-thumbs-down-${photoId}`);
          if (reaction === 'üëç' && thumbsUpElem) {
            thumbsUpElem.textContent = data.thumbs_up;
          } else if (reaction === 'üëé' && thumbsDownElem) {
            thumbsDownElem.textContent = data.thumbs_down;
          }
      })
      .catch(error => {
          console.error('Error adding reaction:', error);
      });
    }
  </script>
  <script src="{% static 'petreal/js/petreal.js' %}"></script>
{% endblock %}

{% block content %}
<div class="petreal-container">
  <div class="petreal-hero">
    <h1>üì∑ PetReal üì∑</h1>
    <h5>Capture Your Authentic Moments Every Day!</h5>
    <hr>
    <p>Swipe through recent posts and share your reactions.</p>
  </div>
  
  {# (If no daily photo has been posted, display a take-photo button) #}
  {% if not has_photo %}
    <div class="container text-center my-4">
      <button class="btn btn-primary" id="takePhotoBtn">Take Photo</button>
    </div>
  {% endif %}
  
  {# Hidden file input for uploading a photo #}
  <input type="file" id="photoInput" accept="image/*" style="display: none;">

  <div class="container">
    <div class="row mb-4">
      <div class="col text-center">
        <h2>Recent PetReal Posts</h2>
      </div>
    </div>
    <div class="photo-carousel">
      {% for photo in photos %}
        <div class="photo-card" data-photo-user="{{ photo.user }}">
          <div class="card h-100">
            <div class="card-body text-center">
              <h4 class="card-title">{{ photo.user }}'s Post</h4>
              {% if photo.is_video %}
                <video autoplay loop playsinline muted style="width: 100%;">
                  <source src="{{ photo.photo_url }}" type="video/webm">
                  Your browser does not support the video tag.
                </video>
              {% else %}
                <img src="{{ photo.photo_url }}" alt="{{ photo.user }}'s post">
              {% endif %}
            </div>
            <div class="card-footer text-center">
              <div class="reaction-container" data-photo-user="{{ photo.user }}">
                <div class="reaction-icon" onclick="addReaction('{{ photo.id }}', 'üëç')">
                  <span class="emoji">üëç</span>
                  <span class="reaction-count" id="reaction-thumbs-up-{{ photo.id }}">{{ photo.reactions.thumbs_up|default:"0" }}</span>
                </div>
                <div class="reaction-icon" onclick="addReaction('{{ photo.id }}', 'üëé')">
                  <span class="emoji">üëé</span>
                  <span class="reaction-count" id="reaction-thumbs-down-{{ photo.id }}">{{ photo.reactions.thumbs_down|default:"0" }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% empty %}
        <div class="text-center">
          <p>No posts to display.</p>
        </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}
