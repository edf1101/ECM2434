{% extends 'layout.html' %}
{% load static %}

{% block title %}EcoPet - Leaderboard{% endblock %}

{% block extrahead %}
    <link rel="stylesheet" href="{% static 'leaderboard/css/leaderboard.css' %}">
{% endblock %}

{% block content %}
    <h1>Leaderboard</h1>
    <div class="leaderboard-container">

        <h2>Global Top Users</h2>
        <table>
            <thead>
            <tr>
                <th>Rank</th>
                <th>Username</th>
                <th>Points</th>
                <th>Badges</th>
            </tr>
            </thead>
            <tbody>
            {% for user in users %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.profile.points }}</td>
                    <td>
                        {% for badge_instance in user.badgeinstance_set.all %}
                            <span class="badge" title="{{ badge_instance.badge.hover_text }}"
                                  style="background-color: {{ badge_instance.badge.colour }}; color: white;">
                                {{ badge_instance.badge.title }}
                            </span>
                        {% endfor %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4">No users available</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="leaderboard-container">
        <h2>Global Top Pets</h2>
        <table>
            <thead>
            <tr>
                <th>Rank</th>
                <th>Pet Name</th>
                <th>Owner</th>
                <th>Health</th>
            </tr>
            </thead>
            <tbody>
            {% for pet in pets %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ pet.name }}</td>
                    <td>{{ pet.owner.username }}</td>
                    <td>{{ pet.health }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4">No pets available</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="leaderboard-container">
        {% if user.is_authenticated %}
            {% if user_groups %}
                <div class="group-selector">
                    <label for="group-select">Select Group:</label>
                    <select id="group-select" onchange="changeGroupLeaderboard()">
                        {% for entry in group_leaderboards %}
                            <option value="{{ entry.group.code }}">{{ entry.group.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                {% for group in group_leaderboards %}
                    <div id="group-leaderboard-{{ group.group.code }}" class="group-leaderboard"
                         style="{% if forloop.first %}display:block;{% else %}display:none;{% endif %}">
                        <h2>Group Leaderboard - {{ group.group.name }}</h2>
                        <table>
                            <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Username</th>
                                <th>Points</th>
                                <th>Badges</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for user in group.users %}
                                <tr {% if user == current_user %}class="current-user"{% endif %}>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ user.username }}</td>
                                    <td>{{ user.total_pet_points }}</td>
                                    <td>
                                        {% for badge_instance in user.badgeinstance_set.all %}
                                            <span title="{{ badge_instance.badge.hover_text }}"
                                                  style="color: {{ badge_instance.badge.colour }}">
                                                {{ badge_instance.badge.title }}
                                            </span>
                                        {% endfor %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4">No users in this group</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endfor %}
            {% else %}
                <p>You are not a member of any groups</p>
            {% endif %}
        {% endif %}
    </div>

    <script>
        /**
         * This function updates a group leaderboard when a group is switched.
         */
        function changeGroupLeaderboard() {
            const select = document.getElementById('group-select');
            const selectedGroup = select.value;
            const leaderboards = document.getElementsByClassName('group-leaderboard');
            for (let i = 0; i < leaderboards.length; i++) {
                leaderboards[i].style.display = 'none';
            }
            const selectedDiv = document.getElementById('group-leaderboard-' + selectedGroup);
            if (selectedDiv) {
                selectedDiv.style.display = 'block';
            }
        }
    </script>





{% endblock %}

